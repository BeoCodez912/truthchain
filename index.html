<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TruthChain: Symbolic Blockchain + TON Wallet</title>
  <style>
    :root{ --bg:#111; --fg:#0f0; --muted:#8f8; --panel:#000; }
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: var(--bg); color: var(--fg); padding: 20px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items:start; }
    .card{ background: var(--panel); border-radius: 10px; padding: 12px; }
    button { background: var(--fg); color: var(--bg); border: none; padding: 8px 16px; margin: 6px 0; cursor: pointer; border-radius: 6px; font-weight:700 }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1f1f1f; background:#0c0c0c; color:var(--fg) }
    label{ color: var(--muted); font-size: 12px; }
    pre { background: var(--panel); padding: 10px; border-radius: 8px; max-height: 420px; overflow: auto; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid #1f1f1f; border-radius:999px; background:#0c0c0c }
  </style>
  <script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
<h2>TruthChain: Symbolic Blockchain + TON Wallet</h2>
<div class="row">
  <div class="card">
    <div id="ton-connect"></div>
    <div>Address: <span id="addr" class="pill">—</span></div>
    <div style="margin-top:8px">
      <label>Recipient Address</label>
      <input id="to" placeholder="e.g. UQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
      <label style="margin-top:8px; display:block">Amount (TON)</label>
      <input id="amount" placeholder="e.g. 0.25" />
      <button id="sendBtn" disabled>Send TON & Record Block</button>
    </div>
    <hr/>
    <button id="addBlockBtn" disabled>Add Block (no transfer)</button>
    <div style="margin-top:8px">
      <button id="withdrawBtn" disabled>Withdraw Mined Value</button>
      <span id="withdrawnValue" class="pill">0</span> TON
    </div>
    <div style="margin-top:8px">
      <label>Symbolic Deposit (for multiplier)</label>
      <input id="depositAmount" placeholder="e.g. 10" />
      <button id="depositBtn" disabled>Deposit</button>
    </div>
    <div style="margin-top:8px">
      <label>Referral Code</label>
      <input id="referralCode" placeholder="Enter referral code" />
      <button id="referralBtn" disabled>Apply Referral</button>
      <div class="pill" id="refBonus">Bonus: 0</div>
    </div>
    <div style="margin-top:8px">
      <label>Mining Multiplier: <span id="mineMultiplier">1x</span></label>
      <div style="height:16px; background:#0c0c0c; border-radius:8px; overflow:hidden;">
        <div id="mineBar" style="width:0%; background:var(--fg); height:100%;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div><b>Latest Hash:</b> <span id="latest-hash"></span></div>
    <div><b>Difficulty:</b> <span id="diff"></span></div>
    <div style="margin-top:8px"><b>Chain (frozen view)</b></div>
    <pre id="output"></pre>
  </div>
</div>

<script>
  // ===== SYMBOLIC ARRAYS =====
  const e=["euGene",5,6,"HEI","EG\uD83C\uDDFA\uD83C\uDDF8"];
  const u=["VAV","WAW",6,e];
  const G=["AC\uD83C\uDDFA\uD83C\uDDF8","BA\uD83C\uDDFA\uD83C\uDDF8","GB\uD83C\uDDFA\uD83C\uDDF8","CE\uD83C\uDDFA\uD83C\uDDF8","YAHWEH","Gimel",3,"https://unpkg.com/@tonconnect/sdk@0.0.34/dist/tonconnect-sdk.min.js"];
  const n=["nun",50,"\u2620\uFE0F"];
  const x=[(Number(u[2])||0)*111.1,(Number(e[1])||0)*133.2,(Number(e[2])||0)*111.1,(Number(G[6])||0)*222];
  const one=["\u2020",555.5,G[4],G[7],n[0]];
  const Matter=164;
  const Time=[Date.now(),"∞"];
  const Immortality=[G[4],Matter];
  const Jesus=[one.join(","),Immortality.join(","),n[0]];
  const latent=[Immortality.join(","),one.join(","),Matter];
  const feature=[Jesus,one[0],n[0]];
  const student=[Matter,G[7]];
  const teacher=[Immortality.join(","),one.join(","),student];
  const label=[Immortality.join(","),one.join(","),Jesus.join(",")];
  const train=[latent.join(","),one[1],Time.join(",")];
  const test=["ß",((Number(e[1])||0)*(Number(n[1])||0)*(Number(G[6])||0)/(Number(one[1])||1))];

  // ===== BLOCK + BLOCKCHAIN =====
  class Block {
    constructor(index,timestamp,data,previousHash=''){
      this.index=index;
      this.timestamp=timestamp;
      this.data=data;
      this.previousHash=previousHash;
      this.nonce=0;
      this.hash=this.calculateHash();
    }
    calculateHash(){
      return CryptoJS.SHA256(this.index+this.timestamp+JSON.stringify(this.data)+this.previousHash+this.nonce).toString();
    }
  }

  class Blockchain{
    #chain;
    #difficulty;
    constructor(difficulty=3){
      this.#chain=[this.createGenesisBlock()];
      this.#difficulty=Number(difficulty);
    }
    createGenesisBlock(){ return new Block(0,new Date().toISOString(),{genesis:true},'0'.repeat(64)); }
    get chain(){ return [...this.#chain]; }
    get latest(){ return this.#chain[this.#chain.length-1]; }
    get difficulty(){ return this.#difficulty; }
    addBlock(data){
      const previousHash=this.latest.hash;
      const index=this.#chain.length;
      const timestamp=new Date().toISOString();
      let nonce=0,hash='',prefix='0'.repeat(this.#difficulty);
      do { hash=CryptoJS.SHA256(index+timestamp+JSON.stringify(data)+previousHash+nonce).toString(); nonce++; } while(!hash.startsWith(prefix));
      const b=new Block(index,timestamp,data,previousHash);
      b.hash=hash; b.nonce=nonce;
      this.#chain.push(b);
      return b;
    }
  }

  const blockchain=new Blockchain(3);

  // ===== TON CONNECT =====
  const manifestUrl='https://BeoCodez912.github.io/truthchain/tonconnect-manifest.json';
  const tonConnectUI=new TON_CONNECT_UI.TonConnectUI({manifestUrl,buttonRootId:'ton-connect',network:'MAINNET'});

  const addrEl=document.getElementById('addr');
  const sendBtn=document.getElementById('sendBtn');
  const addBlockBtn=document.getElementById('addBlockBtn');
  const withdrawBtn=document.getElementById('withdrawBtn');
  const withdrawnValueEl=document.getElementById('withdrawnValue');
  const depositBtn=document.getElementById('depositBtn');
  const depositAmountInput=document.getElementById('depositAmount');
  const referralBtn=document.getElementById('referralBtn');
  const referralInput=document.getElementById('referralCode');
  const refBonusEl=document.getElementById('refBonus');
  const mineMultiplierEl=document.getElementById('mineMultiplier');
  const mineBarEl=document.getElementById('mineBar');

  let minedValue=0;
  let multiplier=1;
  let referralBonus=0;

  async function refreshAddress(){
    const w=await tonConnectUI.getWallet();
    const connected= w && w.account && w.account.address;
    if(connected){
      addrEl.textContent=w.account.address;
      sendBtn.disabled=false;
      addBlockBtn.disabled=false;
      withdrawBtn.disabled=false;
      depositBtn.disabled=false;
      referralBtn.disabled=false;
      return w.account.address;
    }
    addrEl.textContent='—';
    sendBtn.disabled=true;
    addBlockBtn.disabled=true;
    withdrawBtn.disabled=true;
    depositBtn.disabled=true;
    referralBtn.disabled=true;
    return '';
  }

  tonConnectUI.onStatusChange(refreshAddress);
  refreshAddress();

  const out=document.getElementById('output');
  const latestHashEl=document.getElementById('latest-hash');
  const diffEl=document.getElementById('diff');
  diffEl.textContent=String(blockchain.difficulty);

  function render(){
    latestHashEl.textContent=blockchain.latest.hash;
    out.textContent=JSON.stringify(blockchain.chain,null,2);
  }

  const toNano=ton=>{const n=Number(ton);if(!Number.isFinite(n)||n<0)return null;return BigInt(Math.round(n*1e9));};

  function updateMineBar(){
    const width=Math.min((minedValue*multiplier),100);
    mineBarEl.style.width=width+'%';
    mineMultiplierEl.textContent=multiplier.toFixed(2)+'x';
  }

  // Add block (no transfer)
  addBlockBtn.addEventListener('click',async()=>{
    const wallet=await refreshAddress();
    const data={type:'note',tx:'User Block (no transfer)',wallet,arrays:{e,u,G,n,x,one,Matter,Time,Immortality,Jesus,latent,feature,student,teacher,label,train,test}};
    blockchain.addBlock(data);
    minedValue+=1*multiplier;
    updateMineBar();
    render();
  });

  // Send TON
  sendBtn.addEventListener('click',async()=>{
    const to=document.getElementById('to').value.trim();
    const amountTON=document.getElementById('amount').value.trim();
    const nano=toNano(amountTON);
    const fromAddr=await refreshAddress();
    if(!fromAddr){alert('Connect wallet first.');return;}
    if(!to){alert('Enter recipient address.');return;}
    if(nano===null){alert('Enter valid TON amount.');return;}
    const tx={validUntil:Math.floor(Date.now()/1000)+300,messages:[{address:to,amount:nano.toString()}]};
    try{
      const result=await tonConnectUI.sendTransaction(tx);
      const data={type:'transfer',to,amountTON:Number(amountTON),amountNano:nano.toString(),from:fromAddr,walletEnv:'MAINNET',result};
      blockchain.addBlock(data);
      minedValue+=1*multiplier;
      updateMineBar();
      render();
      alert('Transaction sent & block recorded.');
    }catch(err){
      const data={type:'transfer-error',to,amountTON:Number(amountTON),from:fromAddr,error:String(err)};
      blockchain.addBlock(data);
      render();
      alert('Send failed (recorded in chain).');
    }
  });

  // Withdraw mined value
  withdrawBtn.addEventListener('click',async()=>{
    const wallet=await refreshAddress();
    if(minedValue<=0){alert('No mined value to withdraw.'); return;}
    const withdrawn=minedValue;
    minedValue=0;
    updateMineBar();
    const data={type:'withdraw',amount:withdrawn,wallet,timestamp:Date.now()};
    blockchain.addBlock(data);
    withdrawnValueEl.textContent=withdrawn.toFixed(2);
    render();
    alert(`Symbolic withdrawal of ${withdrawn.toFixed(2)} TON recorded as a block.`);
  });

  // Symbolic deposit for multiplier
  depositBtn.addEventListener('click',()=>{
    const amt=Number(depositAmountInput.value);
    if(!amt || amt<=0){alert('Enter positive deposit value'); return;}
    multiplier+=amt/100;
    minedValue+=0; // optional, only affects multiplier
    updateMineBar();
    depositAmountInput.value='';
  });

  // Referral system
  referralBtn.addEventListener('click',()=>{
    const code=referralInput.value.trim();
    if(!code){alert('Enter referral code'); return;}
    referralBonus+=0.1; // each referral adds 0.1x
    multiplier+=0.1;
    refBonusEl.textContent='Bonus: '+referralBonus.toFixed(2);
    referralInput.value='';
    updateMineBar();
  });

  render();
  updateMineBar();
</script>
</body>
</html>
